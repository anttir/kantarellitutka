<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kantarellitutka üçÑ</title>
    <style>
        :root {
            --brand-orange: #ff9800;
        }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #2c2c2c;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #videoContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        video {
            position: absolute; width: 1px; height: 1px; left: -9999px; top: -9999px;
        }
        canvas {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%; min-height: 100%;
            width: auto; height: auto;
            object-fit: cover;
        }
        canvas.calibrating {
            border: 4px solid var(--brand-orange);
            box-sizing: border-box;
        }
        #controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 90%;
            max-width: 420px;
        }
        .control-group { display: flex; flex-direction: column; }
        .control-group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        label { font-size: 0.9em; font-weight: 500; }
        .value-display { font-size: 0.85em; color: #ccc; }
        input[type="range"] { width: 100%; margin: 0; }
        .button-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .button {
            padding: 10px 15px;
            background-color: #444;
            border: none; border-radius: 8px;
            color: white; font-weight: bold; cursor: pointer;
            text-align: center; transition: background-color 0.2s;
            flex-grow: 1;
        }
        .button:hover { background-color: #555; }
        #colorPreview {
            width: 32px; height: 32px;
            border: 2px solid white; border-radius: 8px;
        }
        #advancedToggle { font-size: 0.8em; color: #ccc; cursor: pointer; text-decoration: underline; text-align: center; margin-top: 5px; }
        #advancedControls { display: none; flex-direction: column; gap: 15px; border-top: 1px solid #555; padding-top: 15px;}
        #infoContainer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 90%;
            z-index: 10;
        }
        #infoBox {
            background: var(--brand-orange); color: black;
            padding: 10px 15px; border-radius: 8px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        #cancelCalibrateButton {
            background-color: #555;
            padding: 8px 20px;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="infoContainer">
        <div id="infoBox">Poimi v√§ri napauttamalla n√§ytt√∂√§</div>
        <div id="cancelCalibrateButton" class="button">Peruuta</div>
    </div>

    <div id="controls">
        <!-- Main Controls -->
        <div class="control-group">
            <div class="control-group-header">
                <label for="hueSlider">V√§ris√§vy (Hue)</label>
                <div id="colorPreview"></div>
            </div>
            <input type="range" id="hueSlider" min="0" max="360" value="40">
        </div>
        <div class="control-group">
            <div class="control-group-header">
                <label for="sensitivitySlider">Herkkyys</label>
                <span class="value-display" id="sensitivityValue">50</span>
            </div>
            <input type="range" id="sensitivitySlider" min="0" max="100" value="50">
        </div>
        <div class="control-group">
            <div class="control-group-header">
                <label for="dimmerSlider">Taustan tummuus</label>
                <span class="value-display" id="dimmerValue">80%</span>
            </div>
            <input type="range" id="dimmerSlider" min="20" max="100" value="80">
        </div>
        <div class="button-row">
            <div id="calibrateButton" class="button">Poimi V√§ri</div>
            <div id="resetButton" class="button">Nollaa</div>
        </div>
        <div id="advancedToggle">Lis√§asetukset</div>
        <!-- Advanced Controls (hidden) -->
        <div id="advancedControls">
            <div class="control-group">
                <div class="control-group-header">
                    <label for="toleranceSlider">Herkkyys (S√§vyll√§)</label>
                    <span class="value-display" id="toleranceValue">45</span>
                </div>
                <input type="range" id="toleranceSlider" min="1" max="100" value="45">
            </div>
            <div class="control-group">
                <div class="control-group-header">
                    <label for="saturationSlider">V√§himm√§iskyll√§isyys</label>
                    <span class="value-display" id="saturationValue">40</span>
                </div>
                <input type="range" id="saturationSlider" min="0" max="100" value="40">
            </div>
            <div class="control-group">
                <div class="control-group-header">
                    <label for="brightnessSlider">V√§himm√§iskirkkaus</label>
                    <span class="value-display" id="brightnessValue">30</span>
                </div>
                <input type="range" id="brightnessSlider" min="0" max="100" value="30">
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });

        const ui = {
            sliders: {
                hue: document.getElementById('hueSlider'),
                sensitivity: document.getElementById('sensitivitySlider'),
                tolerance: document.getElementById('toleranceSlider'),
                saturation: document.getElementById('saturationSlider'),
                brightness: document.getElementById('brightnessSlider'),
                dimmer: document.getElementById('dimmerSlider'),
            },
            values: {
                sensitivity: document.getElementById('sensitivityValue'),
                tolerance: document.getElementById('toleranceValue'),
                saturation: document.getElementById('saturationValue'),
                brightness: document.getElementById('brightnessValue'),
                dimmer: document.getElementById('dimmerValue'),
            },
            buttons: {
                calibrate: document.getElementById('calibrateButton'),
                reset: document.getElementById('resetButton'),
                cancelCalibrate: document.getElementById('cancelCalibrateButton'),
            },
            colorPreview: document.getElementById('colorPreview'),
            advancedToggle: document.getElementById('advancedToggle'),
            advancedControls: document.getElementById('advancedControls'),
            infoContainer: document.getElementById('infoContainer'),
        };
        
        const defaultSettings = {
            targetH: 40,
            sensitivity: 50,
            tolerance: 45,
            minS: 40,
            minV: 30,
            dimmer: 0.8,
        };
        let settings = { ...defaultSettings };
        let isFilterActive = true;

        function hsvToCssHsl(h, s, v) {
            return `hsl(${h}, ${s}%, ${v * 0.5 + 25}%)`;
        }
        
        function rgbToHsv(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            let d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) { h = 0; }
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return [h * 360, s * 100, v * 100];
        }

        function mapValue(value, in_min, in_max, out_min, out_max) {
            return (value - in_min) * (out_max - out_min) / (in_max - in_min) + out_min;
        }
        
        function enterCalibrationMode() {
            isFilterActive = false;
            ui.infoContainer.style.display = 'flex';
            canvas.classList.add('calibrating');
        }
        
        function exitCalibrationMode() {
            isFilterActive = true;
            ui.infoContainer.style.display = 'none';
            canvas.classList.remove('calibrating');
        }

        function updateUI() {
            ui.sliders.hue.value = settings.targetH;
            ui.sliders.sensitivity.value = settings.sensitivity;
            ui.sliders.tolerance.value = settings.tolerance;
            ui.sliders.saturation.value = settings.minS;
            ui.sliders.brightness.value = settings.minV;
            ui.sliders.dimmer.value = settings.dimmer * 100;

            ui.values.sensitivity.textContent = settings.sensitivity;
            ui.values.tolerance.textContent = settings.tolerance;
            ui.values.saturation.textContent = settings.minS;
            ui.values.brightness.textContent = settings.minV;
            ui.values.dimmer.textContent = `${Math.round(settings.dimmer * 100)}%`;
            
            ui.colorPreview.style.backgroundColor = hsvToCssHsl(settings.targetH, 100, 100);
        }
        
        function resetSettings() {
            settings = { ...defaultSettings };
            // Varmistetaan, ett√§ my√∂s yksinkertainen herkkyys-s√§√§din on k√§yt√∂ss√§ resetin j√§lkeen
            if (ui.advancedControls.style.display === 'flex') {
                ui.advancedToggle.click(); // Suljetaan lis√§asetukset
            }
            ui.sliders.sensitivity.disabled = false;
            updateUI();
        }
        
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play().catch(err => console.error("Video play failed:", err));
                    requestAnimationFrame(processFrame);
                };
            } catch (err) {
                alert("Kameran k√§ytt√∂ vaatii luvan. Salli kameran k√§ytt√∂ ja p√§ivit√§ sivu.");
            }
        }

        function processFrame() {
            if (video.readyState < 2 || video.videoWidth === 0) {
                requestAnimationFrame(processFrame);
                return;
            }
            if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            }

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (!isFilterActive) {
                requestAnimationFrame(processFrame);
                return;
            }

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i + 1], b = data[i + 2];
                const [h, s, v] = rgbToHsv(r, g, b);
                const hueDiff = Math.min(Math.abs(h - settings.targetH), 360 - Math.abs(h - settings.targetH));

                if (hueDiff < settings.tolerance && s > settings.minS && v > settings.minV) {
                    // Color matches
                } else {
                    const gray = (0.299 * r + 0.587 * g + 0.114 * b) * settings.dimmer;
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
            }
            ctx.putImageData(imageData, 0, 0);
            requestAnimationFrame(processFrame);
        }

        // --- Event Listeners ---
        ui.sliders.hue.addEventListener('input', e => {
            settings.targetH = parseInt(e.target.value, 10);
            updateUI();
        });

        ui.sliders.sensitivity.addEventListener('input', e => {
            const value = parseInt(e.target.value, 10);
            settings.sensitivity = value;
            // Ohjataan lis√§asetuksia t√§m√§n yhden s√§√§timen kautta
            settings.tolerance = Math.round(mapValue(value, 0, 100, 15, 70));
            settings.minS = Math.round(mapValue(value, 0, 100, 50, 20));
            settings.minV = Math.round(mapValue(value, 0, 100, 40, 15));
            updateUI();
        });

        ui.sliders.tolerance.addEventListener('input', e => {
            settings.tolerance = parseInt(e.target.value, 10);
            updateUI();
        });
        ui.sliders.saturation.addEventListener('input', e => {
            settings.minS = parseInt(e.target.value, 10);
            updateUI();
        });
        ui.sliders.brightness.addEventListener('input', e => {
            settings.minV = parseInt(e.target.value, 10);
            updateUI();
        });
        ui.sliders.dimmer.addEventListener('input', e => {
            settings.dimmer = parseInt(e.target.value, 10) / 100;
            updateUI();
        });
        
        ui.buttons.reset.addEventListener('click', resetSettings);
        
        ui.advancedToggle.addEventListener('click', () => {
            const isVisible = ui.advancedControls.style.display === 'flex';
            ui.advancedControls.style.display = isVisible ? 'none' : 'flex';
            // Kun lis√§asetukset avataan, poistetaan yksinkertainen herkkyys-s√§√§din k√§yt√∂st√§
            ui.sliders.sensitivity.disabled = !isVisible;
            ui.advancedToggle.textContent = isVisible ? 'Lis√§asetukset' : 'Piilota lis√§asetukset';
        });

        ui.buttons.calibrate.addEventListener('click', enterCalibrationMode);
        ui.buttons.cancelCalibrate.addEventListener('click', exitCalibrationMode);
        
        canvas.addEventListener('click', event => {
            if (isFilterActive) return;
            const rect = canvas.getBoundingClientRect();
            const x = Math.round((event.clientX - rect.left) * (canvas.width / rect.width));
            const y = Math.round((event.clientY - rect.top) * (canvas.height / rect.height));
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const pixel = ctx.getImageData(x, y, 1, 1).data;
            const [h, s, v] = rgbToHsv(pixel[0], pixel[1], pixel[2]);
            
            settings.targetH = Math.round(h);
            updateUI();
            exitCalibrationMode();
        });

        // --- Initialization ---
        resetSettings();
    </script>
</body>
</html>
